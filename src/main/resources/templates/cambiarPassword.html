<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{index}">
    <body layout:fragment="contenido">
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header text-center">
                            <h4>Cambiar contraseña</h4>
                        </div>
                        <div class="card-body">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label class="form-label">Contraseña actual</label>
                                    <input type="password" id="currentPassword" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nueva contraseña</label>
                                    <input type="password" id="newPassword" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirmar nueva contraseña</label>
                                    <input type="password" id="confirmPassword" class="form-control" required>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" onclick="cambiarPassword()">
                                        Cambiar contraseña
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script th:inline="javascript">
            function cambiarPassword() {

                const passwordActual = $("#currentPassword").val();
                const passwordNueva = $("#newPassword").val();
                const confirmPassword = $("#confirmPassword").val();

                if (passwordNueva !== confirmPassword) {
                    Swal.fire("Error", "Las contraseñas no coinciden", "warning");
                    return;
                }

                const data = {
                    passwordActual: passwordActual,
                    passwordNueva: passwordNueva
                };

                const token = sessionStorage.getItem("tokenUser"); 

                $.ajax({
                    url: "http://localhost:8080/api/usuarios/cambiarPassword",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    success: function (resp) {
                        Swal.fire({
                            icon: "success",
                            title: "Éxito",
                            text: resp.object,
                            confirmButtonText: "Aceptar"
                        })
                        setTimeout(function () {
                            window.history.back();
                        }, 3000);
                    },
                    error: function (xhr) {
                        let mensaje = "Error al cambiar la contraseña";
                        if (xhr.responseJSON?.object) {
                            mensaje = xhr.responseJSON.object;
                        }
                        Swal.fire("Error", mensaje, "error");
                    }
                });
            }
        </script>
    </body>
</html>
